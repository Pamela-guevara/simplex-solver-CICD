name: CI ¬∑ Build ¬∑ CodeQL ¬∑ GHCR ¬∑ Render ¬∑ Discord

on:
  push:
    branches: ["main", "master"]
  #workflow_dispatch:

env:
  VERSION: v1.0.${{ github.run_number }}
  GHCR_OWNER: ${{ secrets.GH_USERNAME }}
  BACKEND_IMAGE: ghcr.io/${{ secrets.GH_USERNAME }}/simplex-solver-backend
  FRONTEND_IMAGE: ghcr.io/${{ secrets.GH_USERNAME }}/simplex-solver-frontend
  RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
  BACKEND_SERVICE: simplex-backend
  FRONTEND_SERVICE: simplex-frontend
  REGION: oregon

permissions:
  contents: read
  packages: write
  security-events: write
  id-token: write

jobs:
  # =========================================================
  # 1Ô∏è‚É£ CODEQL ANALYSIS
  # =========================================================
  codeql:
    name: Static Analysis (CodeQL)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: python, javascript
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  # =========================================================
  # 2Ô∏è‚É£ BACKEND TESTS
  # =========================================================
  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-24.04
    needs: codeql
    defaults:
      run:
        shell: bash
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run pytest
        run: pytest -q
      - name: Run manual test
        run: python -m tests.test_manual

  # =========================================================
  # 3Ô∏è‚É£ BUILD & PUSH IMAGES
  # =========================================================
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-24.04
    needs: backend-tests
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GH_USERNAME }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      # --- Build Backend ---
      - name: Build & Push Backend Image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:${{ env.VERSION }}
            ${{ env.BACKEND_IMAGE }}:latest

      # --- Build Frontend ---
      - name: Build & Push Frontend Image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:${{ env.VERSION }}
            ${{ env.FRONTEND_IMAGE }}:latest
          build-args: |
            NGINX_CONF=nginx_render.conf

  # =========================================================
  # 4Ô∏è‚É£ DEPLOY TO RENDER
  # =========================================================
  deploy-render:
    name: Deploy to Render
    runs-on: ubuntu-24.04
    needs: build-and-push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get existing services
        id: get-services
        run: |
          echo "üîç Fetching existing services..."

          SERVICES_JSON=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services?limit=20")

          echo "Services Response:"
          echo "$SERVICES_JSON" | jq '.' || echo "$SERVICES_JSON"

          # Buscar servicios por nombre
          BACKEND_ID=$(echo "$SERVICES_JSON" | jq -r '.[] | select(.service.name=="${{ env.BACKEND_SERVICE }}") | .service.id' | head -n1)
          FRONTEND_ID=$(echo "$SERVICES_JSON" | jq -r '.[] | select(.service.name=="${{ env.FRONTEND_SERVICE }}") | .service.id' | head -n1)

          # Exportar como variables de ambiente
          echo "BACKEND_ID=${BACKEND_ID}" >> $GITHUB_ENV
          echo "FRONTEND_ID=${FRONTEND_ID}" >> $GITHUB_ENV

          echo "‚úÖ Backend ID: ${BACKEND_ID:-not found}"
          echo "‚úÖ Frontend ID: ${FRONTEND_ID:-not found}"

      - name: Create Backend Service (if not exists)
        if: env.BACKEND_ID == '' || env.BACKEND_ID == 'null'
        run: |
          echo "üÜï Creating new backend service..."

          IMAGE_URL="${{ env.BACKEND_IMAGE }}:latest"

          # Crear JSON usando heredoc para evitar problemas de escape
          cat > backend_payload.json <<EOF
          {
            "type": "web_service",
            "name": "${{ env.BACKEND_SERVICE }}",
            "ownerId": "${{ secrets.OWNER_ID }}",
            "repo": "https://github.com/${{ github.repository }}",
            "autoDeploy": "no",
            "serviceDetails": {
              "env": "image",
              "envSpecificDetails": {
                "imageUrl": "${IMAGE_URL}",
                "registryCredential": {
                  "username": "${{ secrets.GH_USERNAME }}",
                  "password": "${{ secrets.GHCR_PAT }}"
                }
              },
              "region": "${{ env.REGION }}",
              "plan": "starter",
              "pullRequestPreviewsEnabled": "no"
            }
          }
          EOF

          echo "üìÑ Backend JSON payload:"
          cat backend_payload.json | jq '.'

          # Hacer la petici√≥n con mejor manejo de errores
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST "https://api.render.com/v1/services" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d @backend_payload.json)

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')

          echo "üìä HTTP Status: $HTTP_CODE"
          echo "üìÑ Response Body:"
          echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"

          # Validar respuesta
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            BACKEND_ID=$(echo "$BODY" | jq -r '.service.id // .id')
            echo "‚úÖ Backend service created successfully!"
            echo "BACKEND_ID=$BACKEND_ID" >> $GITHUB_ENV
          else
            echo "‚ùå Failed to create backend service (HTTP $HTTP_CODE)"
            echo "Error details: $BODY"
            exit 1
          fi

      - name: Create Frontend Service (if not exists)
        if: env.FRONTEND_ID == '' || env.FRONTEND_ID == 'null'
        run: |
          echo "üÜï Creating new frontend service..."

          IMAGE_URL="${{ env.FRONTEND_IMAGE }}:latest"

          # Crear JSON para frontend
          cat > frontend_payload.json <<EOF
          {
            "type": "web_service",
            "name": "${{ env.FRONTEND_SERVICE }}",
            "ownerId": "${{ secrets.OWNER_ID }}",
            "repo": "https://github.com/${{ github.repository }}",
            "autoDeploy": "no",
            "serviceDetails": {
              "env": "image",
              "envSpecificDetails": {
                "imageUrl": "${IMAGE_URL}",
                "registryCredential": {
                  "username": "${{ secrets.GH_USERNAME }}",
                  "password": "${{ secrets.GHCR_PAT }}"
                }
              },
              "region": "${{ env.REGION }}",
              "plan": "starter",
              "pullRequestPreviewsEnabled": "no"
            },
            "envVars": [
              {
                "key": "BACKEND_URL",
                "value": "https://${{ env.BACKEND_SERVICE }}.onrender.com"
              }
            ]
          }
          EOF

          echo "üìÑ Frontend JSON payload:"
          cat frontend_payload.json | jq '.'

          # Hacer la petici√≥n
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST "https://api.render.com/v1/services" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d @frontend_payload.json)

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')

          echo "üìä HTTP Status: $HTTP_CODE"
          echo "üìÑ Response Body:"
          echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"

          # Validar respuesta
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            FRONTEND_ID=$(echo "$BODY" | jq -r '.service.id // .id')
            echo "‚úÖ Frontend service created successfully!"
            echo "FRONTEND_ID=$FRONTEND_ID" >> $GITHUB_ENV
          else
            echo "‚ùå Failed to create frontend service (HTTP $HTTP_CODE)"
            echo "Error details: $BODY"
            exit 1
          fi

      - name: Update Backend Service (if exists)
        if: env.BACKEND_ID != '' && env.BACKEND_ID != 'null'
        run: |
          echo "üîÑ Updating existing backend service: $BACKEND_ID"

          IMAGE_URL="${{ env.BACKEND_IMAGE }}:latest"

          # Actualizar la imagen del servicio
          cat > update_backend.json <<EOF
          {
            "serviceDetails": {
              "envSpecificDetails": {
                "imageUrl": "${IMAGE_URL}"
              }
            }
          }
          EOF

          curl -s -X PATCH "https://api.render.com/v1/services/$BACKEND_ID" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d @update_backend.json | jq '.'

      - name: Update Frontend Service (if exists)
        if: env.FRONTEND_ID != '' && env.FRONTEND_ID != 'null'
        run: |
          echo "üîÑ Updating existing frontend service: $FRONTEND_ID"

          IMAGE_URL="${{ env.FRONTEND_IMAGE }}:latest"

          # Actualizar la imagen del servicio
          cat > update_frontend.json <<EOF
          {
            "serviceDetails": {
              "envSpecificDetails": {
                "imageUrl": "${IMAGE_URL}"
              }
            }
          }
          EOF

          curl -s -X PATCH "https://api.render.com/v1/services/$FRONTEND_ID" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d @update_frontend.json | jq '.'

      - name: Trigger Backend Deploy
        if: env.BACKEND_ID != '' && env.BACKEND_ID != 'null'
        run: |
          echo "üöÄ Deploying backend service..."

          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST "https://api.render.com/v1/services/$BACKEND_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": "clear"}')

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')

          echo "üìä HTTP Status: $HTTP_CODE"
          echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"

      - name: Trigger Frontend Deploy
        if: env.FRONTEND_ID != '' && env.FRONTEND_ID != 'null'
        run: |
          echo "üöÄ Deploying frontend service..."

          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST "https://api.render.com/v1/services/$FRONTEND_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": "clear"}')

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')

          echo "üìä HTTP Status: $HTTP_CODE"
          echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"

  # =========================================================
  # 5Ô∏è‚É£ DISCORD NOTIFICATION
  # =========================================================
  notify:
    name: Discord Notification
    runs-on: ubuntu-24.04
    needs: [deploy-render]
    if: always()
    steps:
      - name: Send status to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ "${{ needs.codeql.result }}" = "success" ] && \
            [ "${{ needs.backend-tests.result }}" = "success" ] && \
            [ "${{ needs.build-and-push.result }}" = "success" ] && \
            [ "${{ needs.deploy-render.result }}" = "success" ]; then
            STATUS="success"
            COLOR=3066993
            TITLE="‚úÖ CI/CD Success"
            DESCRIPTION="All jobs completed successfully"
          else
            STATUS="failure"
            COLOR=15158332
            TITLE="‚ùå CI/CD Failed"
            DESCRIPTION="One or more jobs failed"
          fi

          REPO="${{ github.repository }}"
          URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          VERSION="${{ env.VERSION }}"

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "$TITLE",
              "description": "$DESCRIPTION\n**Repo:** $REPO\n**Version:** $VERSION\n**Workflow:** ${{ github.workflow }}",
              "url": "$URL",
              "color": $COLOR,
              "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "fields": [
                {"name": "CodeQL", "value": "${{ needs.codeql.result }}", "inline": true},
                {"name": "Backend Tests", "value": "${{ needs.backend-tests.result }}", "inline": true},
                {"name": "Build & Push", "value": "${{ needs.build-and-push.result }}", "inline": true},
                {"name": "Deploy to Render", "value": "${{ needs.deploy-render.result }}", "inline": true}
              ]
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "$DISCORD_WEBHOOK"
