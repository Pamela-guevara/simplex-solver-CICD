name: CI Â· Build Â· CodeQL Â· GHCR Â· Render Â· Discord

on:
  #push:
  #  branches: ["main", "master"]
  workflow_dispatch:

env:
  VERSION: v1.0.${{ github.run_number }}
  GHCR_OWNER: ${{ secrets.GH_USERNAME }}
  BACKEND_IMAGE: ghcr.io/${{ secrets.GH_USERNAME }}/simplex-solver-backend
  FRONTEND_IMAGE: ghcr.io/${{ secrets.GH_USERNAME }}/simplex-solver-frontend
  RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
  BACKEND_SERVICE: simplex-backend
  FRONTEND_SERVICE: simplex-frontend
  REGION: oregon
  PLAN: free

permissions:
  contents: read
  packages: write
  security-events: write
  id-token: write

jobs:
  # =========================================================
  # 1ï¸. CODEQL ANALYSIS
  # =========================================================
  codeql:
    name: Static Analysis (CodeQL)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: python, javascript
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  # =========================================================
  # 2ï¸. BACKEND TESTS
  # =========================================================
  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-24.04
    needs: codeql
    defaults:
      run:
        shell: bash
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run pytest
        run: pytest -q
      - name: Run manual test
        run: python -m tests.test_manual

  # =========================================================
  # 3ï¸. BUILD & PUSH IMAGES
  # =========================================================
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-24.04
    needs: backend-tests
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GH_USERNAME }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      # --- Build Backend ---
      - name: Build & Push Backend Image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:${{ env.VERSION }}

      # --- Build Frontend ---
      # - name: Prepare Nginx Config (Replace Backend URL)
      #   run: |
      #     cp frontend/nginx.conf frontend/nginx_render.conf
      #     sed -i 's|proxy_pass http://backend:8000/;|proxy_pass https://simplex-backend.onrender.com/;|' frontend/nginx_render.conf
      #     echo "âœ… Updated nginx.conf for Render deployment"

      - name: Build & Push Frontend Image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:${{ env.VERSION }}
          build-args: |
            NGINX_CONF=nginx_render.conf

  # =========================================================
  # 4ï¸. DEPLOY TO RENDER
  # =========================================================
  deploy-render:
    name: Deploy to Render (Create/Update Services)
    runs-on: ubuntu-24.04
    needs: build-and-push
    # env:
    #   RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get existing services
        id: get-services
        run: |
          # Obtener servicios existentes
          SERVICES_JSON=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" "https://api.render.com/v1/services?limit=5")
          echo "SERVICES_JSON=$SERVICES_JSON" >> $GITHUB_OUTPUT

          BACKEND_ID=$(echo "$SERVICES_JSON" | jq -r '.[] | select(.service.name=="simplex-backend") | .service.id')
          FRONTEND_ID=$(echo "$SERVICES_JSON" | jq -r '.[] | select(.service.name=="simplex-frontend") | .service.id')

          echo "BACKEND_ID=$BACKEND_ID" >> $GITHUB_ENV
          echo "FRONTEND_ID=$FRONTEND_ID" >> $GITHUB_ENV
          echo "Backend ID: $BACKEND_ID"
          echo "Frontend ID: $FRONTEND_ID"

      - name: Create or Update Backend Service
        run: |
          if [ -z "$BACKEND_ID" ]; then
            echo "ðŸ†• Creating new backend service..."
            IMAGE_BE_URL="${{ env.BACKEND_IMAGE }}:${{ env.VERSION }}"
            jq -n \
              --arg name "${{ env.BACKEND_SERVICE }}" \
              --arg ownerId "${{ secrets.OWNER_ID }}" \
              --arg image "$IMAGE_BE_URL" \
              --arg regionId "${{ env.REGION }}" \
              --arg username "${{ secrets.GH_USERNAME }}" \
              --arg password "${{ secrets.GHCR_PAT }}" \
              '{
              "autoDeploy": false,
              "branch": null,
              "name": $name,
              "ownerId": $ownerId,
              "image": {
                "url": $image
              },
              "type": "web_service",
              "runtime": "docker",
              "region": $regionId,
              "envVars": [],
              "numInstances": 1,
              "registryCredential": {
                "server": "ghcr.io",
                "username": $username,
                "password": $password
                }
            }' > backend.json

            cat backend.json | jq empty
            
            curl -X POST "https://api.render.com/v1/services" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Content-Type: application/json" \
              -d @backend.json
          else
            echo "ðŸ”„ Backend service already exists with ID: $BACKEND_ID"
          fi

      - name: Create or Update Frontend Service
        run: |
          if [ -z "$FRONTEND_ID" ]; then
            echo "ðŸ†• Creating new frontend service..."
            IMAGE_FE_URL="${{ env.FRONTEND_IMAGE }}:${{ env.VERSION }}"
            jq -n \
              --arg name "${{ env.FRONTEND_SERVICE }}" \
              --arg ownerId "${{ secrets.OWNER_ID }}" \
              --arg image "$IMAGE_FE_URL" \
              --arg regionId "${{ env.REGION }}" \
              --arg backendUrl "https://${{ env.BACKEND_SERVICE }}.onrender.com" \
              --arg username "${{ secrets.GH_USERNAME }}" \
              --arg password "${{ secrets.GHCR_PAT }}" \
              '{
              "autoDeploy": false,
              "branch": null,
              "name": $name,
              "ownerId": $ownerId,
              "type": "web_service",
              "runtime": "docker",
              "image": {
                "url": $image
              },
              "region": $regionId,
              "envVars": [
                {
                  "key": "BACKEND_URL",
                  "value": $backendUrl
                }
              ],
              "registryCredential": {
                "server": "ghcr.io",
                "username": $username,
                "password": $password
              },
            
            }' > frontend.json
            
            cat frontend.json | jq empty
            
            curl -X POST "https://api.render.com/v1/services" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Content-Type: application/json" \
              -d @frontend.json
          else
            echo "ðŸ”„ Frontend service already exists with ID: $FRONTEND_ID"
          fi

      # Trigger deploys
      - name: Trigger Backend Deploy
        if: env.BACKEND_ID != '' && env.BACKEND_ID != 'null'
        run: |
          curl -X POST "https://api.render.com/v1/services/$BACKEND_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{"clearCache": true}"

      - name: Trigger Frontend Deploy
        if: env.FRONTEND_ID != '' && env.FRONTEND_ID != 'null'
        run: |
          curl -X POST "https://api.render.com/v1/services/$FRONTEND_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{"clearCache": true}"

      # - name: Define JSON for Backend service
      # run: |
      #   cat > backend.json <<EOF
      #   {
      #     "serviceDetails": {
      #       "name": "${{ env.BACKEND_SERVICE }}",
      #       "type": "web_service",
      #       "runtime": "docker",
      #       "repo": "${{ github.repository }}",
      #       "region": "${{ env.REGION }}",
      #       "plan": "${{ env.PLAN }}",
      #       "dockerCommand": "",
      #       "envVars": [],
      #       "rootDir": "/",
      #       "dockerImage": "${{ env.BACKEND_IMAGE }}:${{ env.VERSION }}",
      #       "autoDeploy": false,
      #       "numInstances": 1,
      #       "disk": { "name": "data", "mountPath": "/data", "sizeGB": 1 },
      #       "port": 8000
      #     }
      #   }
      #   EOF

      # - name: Define JSON for Frontend service
      #   run: |
      #     cat > frontend.json <<EOF
      #     {
      #       "serviceDetails": {
      #         "name": "${{ env.FRONTEND_SERVICE }}",
      #         "type": "web_service",
      #         "runtime": "docker",
      #         "repo": "${{ github.repository }}",
      #         "region": "${{ env.REGION }}",
      #         "plan": "${{ env.PLAN }}",
      #         "dockerCommand": "",
      #         "rootDir": "/",
      #         "dockerImage": "${{ env.FRONTEND_IMAGE }}:${{ env.VERSION }}",
      #         "autoDeploy": false,
      #         "numInstances": 1,
      #         "envVars": [
      #           { "key": "BACKEND_URL", "value": "https://${{ env.BACKEND_SERVICE }}.onrender.com" }
      #         ],
      #         "port": 80
      #       }
      #     }
      #     EOF

      # # - name: Try to create Backend service
      # #   continue-on-error: true
      # #   run: |
      # #     curl -s -X POST https://api.render.com/v1/services \
      # #       -H "Authorization: Bearer $RENDER_API_KEY" \
      # #       -H "Content-Type: application/json" \
      # #       -d @backend.json || echo "Backend may already exist."

      # # - name: Try to create Frontend service
      # #   continue-on-error: true
      # #   run: |
      # #     curl -s -X POST https://api.render.com/v1/services \
      # #       -H "Authorization: Bearer $RENDER_API_KEY" \
      # #       -H "Content-Type: application/json" \
      # #       -d @frontend.json || echo "Frontend may already exist."

      # - name: Trigger Backend Deploy
      #   run: |
      #     BACK_ID=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" https://api.render.com/v1/services | jq -r '.[] | select(.service.name=="simplex-backend") | .service.id')
      #     curl -s -X POST "https://api.render.com/v1/services/${BACK_ID}/deploys" \
      #       -H "Authorization: Bearer $RENDER_API_KEY" \
      #       -H "Content-Type: application/json" \
      #       -d '{"clearCache":false}' | jq -C .

      # - name: Trigger Frontend Deploy
      #   run: |
      #     FRONT_ID=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" https://api.render.com/v1/services | jq -r '.[] | select(.service.name=="simplex-frontend") | .service.id')
      #     curl -s -X POST "https://api.render.com/v1/services/${FRONT_ID}/deploys" \
      #       -H "Authorization: Bearer $RENDER_API_KEY" \
      #       -H "Content-Type: application/json" \
      #       -d '{"clearCache":false}' | jq -C .

  # =========================================================
  # 5ï¸. DISCORD NOTIFICATION
  # =========================================================
  notify:
    name: Discord Notification
    runs-on: ubuntu-24.04
    needs: [deploy-render]
    if: always()
    steps:
      - name: Send status to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Determinar el estado general del workflow
          if [ "${{ needs.codeql.result }}" = "success" ] && \
            [ "${{ needs.backend-tests.result }}" = "success" ] && \
            [ "${{ needs.build-and-push.result }}" = "success" ] && \
            [ "${{ needs.deploy-render.result }}" = "success" ]; then
            STATUS="success"
            COLOR=3066993
            TITLE="âœ… CI/CD Success"
            DESCRIPTION="All jobs completed successfully"
          else
            STATUS="failure"
            COLOR=15158332
            TITLE="âŒ CI/CD Failed"
            DESCRIPTION="One or more jobs failed"
          fi
          REPO="${{ github.repository }}"
          URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          VERSION="${{ env.VERSION }}"

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "$TITLE",
              "description": "$DESCRIPTION\n**Repo:** $REPO\n**Version:** $VERSION\n**Workflow:** ${{ github.workflow }}",
              "url": "$URL",
              "color": $COLOR,
              "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "fields": [
                {"name": "CodeQL", "value": "${{ needs.codeql.result }}", "inline": true},
                {"name": "Backend Tests", "value": "${{ needs.backend-tests.result }}", "inline": true},
                {"name": "Build & Push", "value": "${{ needs.build-and-push.result }}", "inline": true},
                {"name": "Deploy to Render", "value": "${{ needs.deploy-render.result }}", "inline": true}
              ]
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "$DISCORD_WEBHOOK"
